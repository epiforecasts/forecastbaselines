name: render-readme

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "README.Rmd"
      - ".github/workflows/render-readme.yaml"

permissions: read-all

jobs:
  render-readme:
    runs-on: macos-latest
    permissions:
      contents: write
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repos
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      - name: Setup pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - uses: julia-actions/setup-julia@v2
        with:
          version: '1.11'

      - name: Cache Julia packages
        uses: julia-actions/cache@v2
        with:
          cache-name: julia-cache-artifacts
          cache-compiled: true

      - name: Install dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: any::rmarkdown, ropensci/allcontributors, local::.
          needs: website

      - name: Update contributors
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          tryCatch(
            allcontributors::add_contributors(format = "text"),
            error = function(e) {
              message("Warning: Failed to update contributors: ", e$message)
              message("Continuing without contributor update...")
            }
          )
        shell: Rscript {0}

      - uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: "latest"
          activate-environment: ""

      - name: Link conda for Julia
        run: |
          mkdir -p "$HOME/.julia/conda/3"
          ln -sf "$CONDA" "$HOME/.julia/conda/3/$(uname -m)"
        shell: bash

      - name: Install JuliaCall dependencies
        run: |
          export R_HOME=$(R RHOME)
          julia -e 'ENV["R_HOME"] = raw"'"$R_HOME"'"; using Pkg; Pkg.add("Suppressor"); Pkg.add("RCall"); Pkg.build("RCall")'
        shell: bash

      - name: Setup Julia dependencies
        run: |
          forecastbaselines::setup_ForecastBaselines(verbose = TRUE)
        shell: Rscript {0}

      - name: Compile the readme
        run: |
          rmarkdown::render("README.Rmd")
        shell: Rscript {0}

      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md README.Rmd
          git commit -m "Update README" || echo "No changes to commit"
          git pull --ff-only
          git push origin
